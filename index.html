<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ì£¼ì •ë³µëª¨ì„ ì•„ì§€íŠ¸</title>
    
    <!-- Pretendard Web Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- ê·€ì—¬ìš´ ê¸€ì”¨ì²´ (Gaegu) -->
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* [í…Œë§ˆ] ìš°ì£¼ + 4ê°œì˜ ë°© */
        body { 
            margin: 0; overflow: hidden; 
            background-color: #0f172a; 
            font-family: 'Pretendard', sans-serif; 
            user-select: none; -webkit-user-select: none; 
            touch-action: none;
        }
        canvas { display: block; }
        
        /* ì¸íŠ¸ë¡œ í™”ë©´ */
        #intro-gate {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 1s;
        }
        .gate-door {
            position: absolute; top: 0; width: 50%; height: 100%; background: #334155;
            border-right: 2px solid #475569; transition: transform 1.5s ease-in-out;
            background-image: radial-gradient(#475569 1px, transparent 1px); background-size: 20px 20px;
        }
        .gate-left { left: 0; border-right: 1px solid #000; }
        .gate-right { right: 0; border-left: 1px solid #000; }
        
        .auth-panel {
            z-index: 10000; background: rgba(15, 23, 42, 0.9); padding: 40px;
            border-radius: 20px; border: 1px solid #3b82f6;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
            text-align: center; backdrop-filter: blur(10px);
        }
        .auth-panel h1 { color: #fff; margin: 0 0 20px 0; font-family: 'Gaegu'; font-size: 2rem; }
        .pass-input {
            padding: 10px; font-size: 1.2rem; border-radius: 8px; border: none;
            text-align: center; width: 120px; margin-bottom: 15px; outline: none;
            background: #1e293b; color: #fff; letter-spacing: 5px;
        }
        .enter-btn {
            display: block; width: 100%; padding: 10px; background: #3b82f6;
            color: white; border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 1rem; transition: background 0.2s;
        }
        .enter-btn:hover { background: #2563eb; }

        #blackhole {
            position: fixed; top: 50%; left: 50%; width: 0; height: 0;
            border-radius: 50%; transform: translate(-50%, -50%);
            background: radial-gradient(circle, #000 0%, #4c1d95 40%, transparent 70%);
            z-index: 9000; pointer-events: none;
            opacity: 0;
        }
        .suck-in { animation: suckIn 2s forwards ease-in-out; }

        @keyframes suckIn {
            0% { width: 0; height: 0; opacity: 0; transform: translate(-50%, -50%) rotate(0deg); }
            30% { width: 100px; height: 100px; opacity: 1; }
            100% { width: 300vmax; height: 300vmax; opacity: 1; transform: translate(-50%, -50%) rotate(720deg); }
        }

        /* UI ë ˆì´ì•„ì›ƒ */
        #ui { position: absolute; top: 30px; left: 30px; pointer-events: none; color: #fff; z-index: 10; display: flex; flex-direction: column; gap: 8px; opacity: 0; transition: opacity 1s; }
        
        #sim-controls { display: flex; gap: 6px; pointer-events: auto; }
        #sim-controls button {
            background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px;
            padding: 8px 14px; cursor: pointer; font-size: 0.9rem; color: #fff;
            font-weight: 700; transition: all 0.2s; backdrop-filter: blur(4px);
        }
        #sim-controls button:hover { background: rgba(255,255,255,0.4); transform: translateY(-1px); }
        
        /* ìš°ì£¼ ëŒ„ìŠ¤ ë²„íŠ¼ íš¨ê³¼ */
        #btn-space-dance { color: #fbbf24 !important; border-color: #fbbf24 !important; }
        #btn-space-dance:hover { background: rgba(251, 191, 36, 0.2) !important; box-shadow: 0 0 15px #fbbf24; }

        #mailbox-icon {
            position: absolute; right: 30px; bottom: 150px; width: 50px; height: 60px;
            background: #ef4444; border: 3px solid #b91c1c; border-radius: 8px 8px 0 0;
            cursor: pointer; z-index: 25; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
            transition: transform 0.1s; opacity: 0; 
        }
        #mailbox-icon:active { transform: scale(0.95); }
        #mailbox-icon::after { content: 'âœ‰ï¸'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; }
        
        #input-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 700px; 
            background: rgba(255, 255, 255, 0.95); padding: 12px; border-radius: 50px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 6px; z-index: 30; 
            backdrop-filter: blur(10px); opacity: 0; 
        }
        select, #msg-input {
            border: 1px solid #e2e8f0; background: #fff; padding: 10px; border-radius: 20px; 
            font-family: 'Pretendard'; outline: none; font-size: 0.9rem; color: #334155;
        }
        select { font-weight: bold; cursor: pointer; background-color: #f8fafc; }
        #msg-input { flex: 1; }
        #send-btn { 
            background: #6366f1; color: white; border: none; width: 42px; height: 42px; border-radius: 50%; 
            cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); flex-shrink: 0;
        }
        
        #guide-text {
            position: absolute; top: 30px; right: 30px; text-align: right; pointer-events: none; z-index: 5; opacity: 0;
        }
        #guide-text h2 { margin: 0; color: #fbbf24; font-family: 'Gaegu', cursive; font-size: 1.5rem; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        #guide-text p { color: #cbd5e1; font-size: 0.9rem; margin-top: 5px; }

        @media (max-width: 768px) {
            #ui { top: 15px; left: 50%; transform: translateX(-50%); width: 95%; justify-content: center; }
            #guide-text { display: none; }
            #input-bar { flex-wrap: wrap; justify-content: center; border-radius: 20px; padding: 10px; bottom: 20px;}
            #input-bar select { width: 48%; }
            #input-bar #msg-input { width: 85%; margin-top: 5px; }
        }

        .modal-window { background: #fff; color: #333; }
        .post-it-card { font-family: 'Gaegu', cursive; background: #fffbeb; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tutorial-overlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); z-index: 9990;
        }
        .tutorial-box {
            position: absolute; background: white; padding: 20px; border-radius: 16px;
            width: 280px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: float 2s infinite ease-in-out;
        }
        .tutorial-box::after {
            content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
            border-width: 10px 10px 0; border-style: solid; border-color: white transparent transparent transparent;
        }
        .tuto-btn {
            background: #3b82f6; color: white; border: none; padding: 8px 16px; 
            border-radius: 20px; cursor: pointer; margin-top: 10px; font-weight: bold;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .highlight { z-index: 9991 !important; position: relative; box-shadow: 0 0 0 4px #fbbf24, 0 0 20px #fbbf24; background: rgba(255,255,255,0.1); border-radius: 8px;}
    </style>
</head>
<body>

    <!-- ì¸íŠ¸ë¡œ í™”ë©´ -->
    <div id="intro-gate">
        <div class="gate-door gate-left"></div>
        <div class="gate-door gate-right"></div>
        <div class="auth-panel" id="auth-panel">
            <h1>ğŸ”’ Restricted Area</h1>
            <p style="color:#94a3b8; font-size:0.9rem; margin-bottom:15px;">ìš°ì£¼ì •ë³µì ìŠ¹ì¸ ì½”ë“œ ì…ë ¥</p>
            <input type="password" id="gate-pass" class="pass-input" placeholder="****" maxlength="4" onkeypress="if(event.key==='Enter') unlockGate()">
            <button class="enter-btn" onclick="unlockGate()">ENTER</button>
            <div id="login-msg" style="color:#ef4444; font-size:0.8rem; margin-top:10px; height:1rem;"></div>
        </div>
    </div>
    <div id="blackhole"></div>

    <!-- íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ -->
    <div id="tutorial-overlay" class="tutorial-overlay">
        <div id="tutorial-box" class="tutorial-box">
            <h3 id="tuto-title" style="margin:0 0 10px 0; font-family:'Gaegu'; font-size:1.4rem;">í™˜ì˜í•©ë‹ˆë‹¤!</h3>
            <p id="tuto-desc" style="color:#64748b; font-size:0.95rem; line-height:1.5;">ìš°ì£¼ì •ë³µëª¨ì„ ì•„ì§€íŠ¸ì— ì˜¤ì‹  ê²ƒì„<br>í™˜ì˜í•©ë‹ˆë‹¤! ğŸš€</p>
            <button class="tuto-btn" onclick="nextTutorial()">ë‹¤ìŒ</button>
        </div>
    </div>

    <!-- ë©”ì¸ UI -->
    <div id="ui">
        <div id="sim-controls">
            <button onclick="togglePause()" id="btn-pause">â¸</button>
            <button onclick="restartTutorial()" title="íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸°">â“</button>
            <!-- [NEW] ìš°ì£¼ ëŒ„ìŠ¤ ë²„íŠ¼ -->
            <button onclick="triggerSpaceDance()" id="btn-space-dance" title="ìš°ì£¼ ëŒ„ìŠ¤ íŒŒí‹°!">ğŸ›¸</button>
        </div>
    </div>

    <div id="guide-text">
        <h2>ğŸª ìš°ì£¼ì •ë³µëª¨ì„</h2>
        <p>ìš°ì£¼ì •ë³µìë¥¼ ìœ„í•œ ê³µê°„ì…ë‹ˆë‹¤.<br>íƒ€ì½”ë¥¼ ê±´ë“œë¦¬ë©´ í™”ë¥¼ ë‚¼ì§€ë„ ëª°ë¼ìš”!</p>
    </div>

    <div id="mailbox-icon" onclick="openMyMsgModal()"></div>

    <div id="input-bar">
        <select id="sender-select">
            <option value="ìµëª…">ğŸ•¶ï¸ ìµëª…</option>
            <option value="ì„ìŠ¹ì—°">ì„ìŠ¹ì—°</option>
            <option value="ê¹€ìœ¤ì˜">ê¹€ìœ¤ì˜</option>
            <option value="ì‹¬í•˜ì—°">ì‹¬í•˜ì—°</option>
            <option value="ì •ì†Œì˜">ì •ì†Œì˜</option>
        </select>
        <span style="font-size:1.2rem; color:#cbd5e1;">â¡</span>
        <select id="receiver-select">
            <option value="ALL">ğŸ“¢ ëª¨ë‘ì—ê²Œ</option>
            <option value="ì„ìŠ¹ì—°">ì„ìŠ¹ì—°</option>
            <option value="ê¹€ìœ¤ì˜">ê¹€ìœ¤ì˜</option>
            <option value="ì‹¬í•˜ì—°">ì‹¬í•˜ì—°</option>
            <option value="ì •ì†Œì˜">ì •ì†Œì˜</option>
        </select>
        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" maxlength="50">
        <button id="send-btn">â¤</button>
    </div>

    <canvas id="canvas"></canvas>

    <div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:90;"></div>
    
    <div id="my-msg-modal" class="modal-window" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:340px; height:550px; background:white; border-radius:20px; z-index:100; flex-direction:column; overflow:hidden;">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#f1f5f9;">
            <span style="font-weight:bold; color:#333; font-family:'Gaegu'; font-size:1.2rem;">ğŸ“¬ ìš°í¸í•¨</span>
            <span style="cursor:pointer; font-size:1.5rem;" onclick="closeModal()">Ã—</span>
        </div>
        <div style="flex:1; overflow-y:auto; padding:15px; background:#fff;" id="msg-list-container"></div>
        <div style="padding:15px; background:white; border-top:1px solid #eee; display:flex; gap:5px; flex-direction:column;">
            <div style="font-size:0.8rem; color:#64748b; margin-bottom:5px;">ì•„ë˜ì— ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="my-name-auth" placeholder="ë‚´ ì´ë¦„ (ì˜ˆ: ì‹¬í•˜ì—°)" style="flex:1; padding:12px; border:1px solid #cbd5e1; border-radius:12px; font-family:'Pretendard';">
                <button onclick="checkMyMessages()" style="background:#6366f1; color:white; border:none; padding:0 20px; border-radius:12px; cursor:pointer; font-weight:bold;">í™•ì¸</button>
            </div>
        </div>
    </div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-u6iH46kKf2_G_HXgG3EturUy2-1bIh7sTeocAKPZ1rWpaKso2VPN53-8WSsP6kEe5A/exec";

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    // ìƒíƒœ ë³€ìˆ˜
    let particles = [];
    let humans = [];
    let animals = [];
    let hearts = [];
    let isPaused = false;
    let isInitialized = false;
    // [NEW] ìš°ì£¼ ëŒ„ìŠ¤ ëª¨ë“œ ë³€ìˆ˜
    let isSpaceMode = false;
    let spaceModeTimer = 0;

    // --- ì„¤ì • ê°’ ---
    const CONFIG = {
        text: 'ìš°ì£¼ì •ë³µëª¨ì„',
        colors: ['#ffffff', '#fbbf24', '#f87171', '#60a5fa'] 
    };

    const HUMAN_TYPES = [
        { name: 'ì„ìŠ¹ì—°', hair: 'SHORT', color: '#002a30', room: 0 }, // Room 0: TL
        { name: 'ê¹€ìœ¤ì˜', hair: 'BOB', color: '#f0f8ff', room: 1 },    // Room 1: TR
        { name: 'ì‹¬í•˜ì—°', hair: 'PONYTAIL', color: '#000080', room: 2 },// Room 2: BL
        { name: 'ì •ì†Œì˜', hair: 'MEDIUM', color: '#0047ab', room: 3 }  // Room 3: BR
    ];

    // [FIX] ë™ë¬¼ ë°© ë°°ì • ì„¤ì •
    const ANIMAL_TYPES = [
        { id: 'CAT', name: 'íƒ€ì½”', color: '#9ca3af', ear: 'POINTY', room: 0 }, // ìŠ¹ì—°ë°©
        { id: 'POODLE', name: 'ì½”ì½”', color: '#854d0e', ear: 'PUFFY', room: 1 }, // ìœ¤ì˜ë°©
        { id: 'COCKER1', name: 'í™©í† ì½”ì¹´', color: '#d97706', ear: 'LONG', room: 3 }, // ì†Œì˜ë°©
        { id: 'COCKER2', name: 'ì–¼ë£©ì½”ì¹´', color: '#e5e7eb', sub: '#4b5563', ear: 'LONG_MIX', room: 3 } // ì†Œì˜ë°©
    ];

    // ì•”í˜¸ ë° ì¸íŠ¸ë¡œ ë¡œì§
    function unlockGate() {
        const pass = document.getElementById('gate-pass').value;
        const msg = document.getElementById('login-msg');
        if (pass === '1218') {
            msg.innerText = '';
            document.getElementById('auth-panel').style.display = 'none'; 
            const bh = document.getElementById('blackhole');
            bh.classList.add('suck-in');
            setTimeout(() => {
                document.getElementById('intro-gate').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('intro-gate').style.display = 'none';
                    document.getElementById('blackhole').style.display = 'none';
                    startGame(); 
                }, 1000);
            }, 1500);
        } else {
            msg.innerText = 'ì ‘ê·¼ ê±°ë¶€: ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            const panel = document.getElementById('auth-panel');
            panel.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-10px)' }, { transform: 'translateX(10px)' }, { transform: 'translateX(0)' }], { duration: 300 });
        }
    }

    function startGame() {
        if (!isInitialized) {
            init(); drawScene(); isInitialized = true;
            document.getElementById('ui').style.opacity = '1';
            document.getElementById('guide-text').style.opacity = '1';
            document.getElementById('input-bar').style.opacity = '1';
            document.getElementById('mailbox-icon').style.opacity = '1';
            setTimeout(() => { runTutorial(); }, 1000);
        }
    }

    // íŠœí† ë¦¬ì–¼ ë¡œì§
    let tutoStep = 0;
    const tutoSteps = [
        { title: "ìš°ì£¼ì •ë³µìë‹˜ í™˜ì˜í•´ìš”! ğŸ‘‹", desc: "ì´ê³³ì€ ìš°ë¦¬ë“¤ë§Œì˜ ë¹„ë°€ ì•„ì§€íŠ¸ì…ë‹ˆë‹¤.<br>ê°ìì˜ ë°©ì—ì„œ ì‰¬ê³  ìˆëŠ” ì¹œêµ¬ë“¤ì„ êµ¬ê²½í•˜ì„¸ìš”.", target: null },
        { title: "ìµëª… ë©”ì‹œì§€ ì „ì†¡ ğŸ“¨", desc: "ì—¬ê¸°ì„œ ì¹œêµ¬ì—ê²Œ(í˜¹ì€ ëª¨ë‘ì—ê²Œ)<br>í•˜ê³  ì‹¶ì€ ë§ì„ <b>ìµëª…</b>ìœ¼ë¡œ ë³´ë‚¼ ìˆ˜ ìˆì–´ìš”.", target: 'input-bar' },
        { title: "ìš°í¸í•¨ í™•ì¸ ğŸ“®", desc: "ë‚˜ì—ê²Œ ì˜¨ í¸ì§€ëŠ” ì—¬ê¸°ì„œ í™•ì¸í•˜ì„¸ìš”.<br>ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ë‚´ í¸ì§€ë¥¼ ëª¨ì•„ì¤ë‹ˆë‹¤.", target: 'mailbox-icon' },
        { title: "í„°ì¹˜í•´ë³´ì„¸ìš”! ğŸ‘†", desc: "ì¹œêµ¬ë“¤ì´ë‚˜ ê°•ì•„ì§€ë¥¼ ëˆ„ë¥´ë©´ í•˜íŠ¸ê°€ ë‚˜ì™€ìš”.<br>í•˜ì§€ë§Œ <b>íƒ€ì½”(ê³ ì–‘ì´)</b>ëŠ” ì¡°ì‹¬í•˜ì„¸ìš”!<br>í• í€¼ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤. ğŸ˜¾", target: null },
        { title: "ìš°ì£¼ ëŒ„ìŠ¤ íŒŒí‹°! ğŸ›¸", desc: "ì™¼ìª½ ìœ„ì˜ <b>UFO ë²„íŠ¼</b>ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.<br>ëª¨ë‘ê°€ ìš°ì£¼ë³µì„ ì…ê³  ì¶¤ì„ ì¶¥ë‹ˆë‹¤! ğŸ’ƒğŸ•º", target: 'btn-space-dance' }
    ];

    function runTutorial() { tutoStep = 0; document.getElementById('tutorial-overlay').style.display = 'block'; updateTutorial(); }
    function restartTutorial() { runTutorial(); }
    function updateTutorial() {
        const step = tutoSteps[tutoStep];
        const box = document.getElementById('tutorial-box');
        const title = document.getElementById('tuto-title');
        const desc = document.getElementById('tuto-desc');
        const prev = document.querySelector('.highlight');
        if(prev) prev.classList.remove('highlight');
        title.innerHTML = step.title; desc.innerHTML = step.desc;
        if (step.target) {
            const el = document.getElementById(step.target);
            el.classList.add('highlight');
            const rect = el.getBoundingClientRect();
            let top = rect.top - 180; let left = rect.left + rect.width/2 - 140;
            if (left < 10) left = 10; if (left + 280 > window.innerWidth) left = window.innerWidth - 290; if (top < 50) top = rect.bottom + 20;
            box.style.top = top + 'px'; box.style.left = left + 'px'; box.style.transform = 'none';
        } else {
            box.style.top = '50%'; box.style.left = '50%'; box.style.transform = 'translate(-50%, -50%)';
        }
    }
    function nextTutorial() {
        tutoStep++;
        if (tutoStep >= tutoSteps.length) { document.getElementById('tutorial-overlay').style.display = 'none'; const prev = document.querySelector('.highlight'); if(prev) prev.classList.remove('highlight'); } 
        else { updateTutorial(); }
    }

    // --- ê·¸ë˜í”½ ìœ í‹¸ë¦¬í‹° ---
    function drawRoundRect(ctx, x, y, w, h, r) {
        if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
        ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath(); ctx.fill();
    }

    // --- ë°© ê·¸ë¦¬ê¸° ---
    function drawRooms(ctx, width, height) {
        // ìš°ì£¼ ëª¨ë“œì¼ ë• ë°© ë°°ê²½ì„ ì–´ë‘¡ê²Œ
        if (isSpaceMode) {
            ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,width,height);
            return;
        }

        const rw = width / 2; const rh = height / 2;
        drawSeungyeonRoom(ctx, 0, 0, rw, rh);
        drawYunyoungRoom(ctx, rw, 0, rw, rh);
        drawHayeonRoom(ctx, 0, rh, rw, rh);
        drawSoyoungRoom(ctx, rw, rh, rw, rh);
        
        ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(rw, 0); ctx.lineTo(rw, height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, rh); ctx.lineTo(width, rh); ctx.stroke();
    }

    function drawSeungyeonRoom(ctx, x, y, w, h) {
        ctx.fillStyle = '#0f2f36'; ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#0b2329'; ctx.fillRect(x, y + h*0.6, w, h*0.4);
        ctx.fillStyle = '#1a4d55'; ctx.fillRect(x + 20, y + h*0.6 - 30, 80, 50); 
        ctx.fillStyle = '#2f6f7a'; ctx.fillRect(x + 20, y + h*0.6, 120, 80); 
        ctx.fillStyle = '#e0f2f1'; ctx.fillRect(x + 30, y + h*0.6 + 10, 40, 20); 
    }

    function drawYunyoungRoom(ctx, x, y, w, h) {
        ctx.fillStyle = '#e6f2ff'; ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#cce5ff'; ctx.fillRect(x, y + h*0.6, w, h*0.4);
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.ellipse(x + w/2, y + h*0.8, 80, 40, 0, 0, Math.PI*2); ctx.fill(); 
        ctx.fillStyle = '#99ccff'; ctx.fillRect(x + w - 120, y + h*0.6 - 40, 100, 60); 
    }

    function drawHayeonRoom(ctx, x, y, w, h) {
        ctx.fillStyle = '#1a237e'; ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#0d1642'; ctx.fillRect(x, y + h*0.6, w, h*0.4);
        ctx.fillStyle = '#283593'; drawRoundRect(ctx, x + 50, y + h*0.6 - 20, 100, 60, 10);
        ctx.fillStyle = '#000'; ctx.fillRect(x + w/2 - 40, y + 50, 80, 60);
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x+w/2, y+80, 2, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#3949ab'; ctx.fillRect(x + w - 120, y + h*0.6, 100, 50); 
    }

    function drawSoyoungRoom(ctx, x, y, w, h) {
        ctx.fillStyle = '#0047ab'; ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#003380'; ctx.fillRect(x, y + h*0.6, w, h*0.4);
        ctx.fillStyle = '#2962ff'; ctx.fillRect(x + w - 80, y + h*0.4, 60, 120);
        ctx.fillStyle = '#448aff'; ctx.fillRect(x + 50, y + 50, 40, 50);
    }

    // --- [NEW] ìš°ì£¼ ëŒ„ìŠ¤ ë¡œì§ ---
    function triggerSpaceDance() {
        if (isSpaceMode) return;
        isSpaceMode = true;
        spaceModeTimer = 500; // ì§€ì† ì‹œê°„
        
        // ì„¬ê´‘ íš¨ê³¼
        const flash = document.createElement('div');
        flash.style.position = 'fixed'; flash.style.top=0; flash.style.left=0; flash.style.width='100%'; flash.style.height='100%';
        flash.style.background = 'white'; flash.style.zIndex = 9999; flash.style.transition = 'opacity 0.5s';
        document.body.appendChild(flash);
        setTimeout(() => { flash.style.opacity = 0; setTimeout(() => flash.remove(), 500); }, 100);

        // ëª¨ë‘ ì¤‘ì•™ìœ¼ë¡œ ì†Œí™˜ + ì¶¤ì¶”ê¸° ìƒíƒœ
        [...humans, ...animals].forEach(ent => {
            ent.state = 'DANCE';
            ent.x = width/2 + (Math.random()-0.5)*300;
            ent.y = height/2 + (Math.random()-0.5)*200;
            ent.targetX = ent.x; ent.targetY = ent.y;
        });
    }

    class Particle {
        constructor(tx, ty) {
            this.tx = tx; this.ty = ty; this.x = Math.random() * width; this.y = Math.random() * height;
            this.color = CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)];
            this.size = Math.random() * 2 + 1; this.speed = Math.random() * 0.05 + 0.02; this.angle = Math.random() * Math.PI * 2;
        }
        update() { const dx = this.tx - this.x; const dy = this.ty - this.y; this.x += dx * 0.05; this.y += dy * 0.05; this.angle += this.speed; }
        draw() { ctx.fillStyle = this.color; ctx.globalAlpha = 0.5 + Math.sin(this.angle) * 0.5; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; }
    }

    class Heart {
        constructor(x, y) { this.x = x; this.y = y; this.size = Math.random() * 5 + 8; this.speedY = Math.random() * 1 + 1; this.life = 1.0; this.color = '#ff69b4'; }
        update() { this.y -= this.speedY; this.life -= 0.02; }
        draw() { if (this.life <= 0) return; ctx.save(); ctx.translate(this.x, this.y); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.moveTo(0, 0); ctx.bezierCurveTo(-this.size/2, -this.size/2, -this.size, this.size/3, 0, this.size); ctx.bezierCurveTo(this.size, this.size/3, this.size/2, -this.size/2, 0, 0); ctx.fill(); ctx.restore(); }
    }

    class Entity {
        constructor() {
            this.x = width/2; this.y = height/2; this.targetX = this.x; this.targetY = this.y;
            this.state = 'IDLE'; this.timer = Math.random() * 100; this.direction = 1; 
        }
        updateMovement(speed = 1) {
            if (this.state === 'WALK' || this.state === 'RUN' || this.state === 'FLY_HOME') {
                const dx = this.targetX - this.x; const dy = this.targetY - this.y; const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 5) { 
                    if (this.state === 'FLY_HOME') { this.state = 'IDLE'; isSpaceMode = false; } // ë³µê·€ ì™„ë£Œ
                    else { this.state = 'IDLE'; this.timer = 50 + Math.random() * 100; }
                } 
                else { this.x += (dx / dist) * speed; this.y += (dy / dist) * speed; this.direction = dx > 0 ? 1 : -1; }
            }
        }
        checkClick(mx, my) { return (mx > this.x - 25 && mx < this.x + 25 && my > this.y - 60 && my < this.y + 10); }
    }

    class Human extends Entity {
        constructor(data, idx) {
            super();
            this.type = data; this.color = data.color; this.homeRoom = data.room;
            const rw = width/2; const rh = height/2;
            const rx = (this.homeRoom % 2) * rw; const ry = Math.floor(this.homeRoom / 2) * rh;
            this.x = rx + rw/2; this.y = ry + rh/2 + 50; 
        }
        setRandomTarget() {
            const rw = width/2; const rh = height/2;
            let roomIdx = this.homeRoom;
            // [FIX] ë‹¤ë¥¸ ë°© ë°©ë¬¸ í™•ë¥  ì¦ê°€ (20% -> 40%)
            if (Math.random() < 0.4) roomIdx = Math.floor(Math.random() * 4);
            const rx = (roomIdx % 2) * rw; const ry = Math.floor(roomIdx / 2) * rh;
            this.targetX = rx + 50 + Math.random() * (rw - 100);
            this.targetY = ry + rh*0.6 + Math.random() * (rh*0.3); 
        }
        returnHome() {
            const rw = width/2; const rh = height/2;
            const rx = (this.homeRoom % 2) * rw; const ry = Math.floor(this.homeRoom / 2) * rh;
            this.targetX = rx + rw/2; this.targetY = ry + rh/2 + 50;
            this.state = 'FLY_HOME';
        }
        update() {
            if (isPaused) return;
            
            // [NEW] ìš°ì£¼ ëŒ„ìŠ¤ ëª¨ë“œ
            if (isSpaceMode && this.state === 'DANCE') {
                spaceModeTimer--;
                if (spaceModeTimer <= 0) this.returnHome(); // ì‹œê°„ ëë‚˜ë©´ ë³µê·€
                return; // ì¶¤ë§Œ ì¶¤
            }
            if (this.state === 'FLY_HOME') {
                this.updateMovement(5); // ë¹ ë¥¸ ì†ë„ë¡œ ë³µê·€
                return;
            }

            this.timer--;
            if (this.timer <= 0) {
                const r = Math.random();
                // [FIX] í•˜ì—°ì´ AI ì‘ì—… í™•ë¥  (ë” ì¦ê°€: 0.6 -> 0.8)
                if (this.type.name === 'ì‹¬í•˜ì—°' && r < 0.8) {
                    this.state = 'AI_WORK'; this.timer = 600;
                    const rw = width/2; const rh = height/2;
                    this.targetX = rw - 80; this.targetY = rh + rh*0.6 + 40;
                } else if (r < 0.3) { this.state = 'WALK'; this.setRandomTarget(); this.timer = 300; } 
                else if (r < 0.5) { this.state = 'PHONE'; this.timer = 300; } 
                else if (r < 0.65) { this.state = 'READ'; this.timer = 400; } 
                else if (r < 0.75) { this.state = 'WRITE'; this.timer = 400; } 
                else if (r < 0.85) { this.state = 'CLAP'; this.timer = 200; } 
                else if (this.type.name === 'ì •ì†Œì˜' && r < 0.95) { this.state = 'PHOTO'; this.timer = 250; } 
                else { this.state = 'SLEEP'; this.timer = 300; }
            }
            
            if (this.state === 'AI_WORK') {
                const dx = this.targetX - this.x; const dy = this.targetY - this.y; const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > 5) { this.x += (dx/dist)*1.5; this.y += (dy/dist)*1.5; this.direction = dx>0?1:-1; }
                else { this.direction = 1; } 
            } else {
                this.updateMovement(1);
            }
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            
            // [NEW] ìš°ì£¼ë³µ ê·¸ë¦¬ê¸° (DANCE or FLY_HOME)
            if (this.state === 'DANCE' || this.state === 'FLY_HOME') {
                if (this.state === 'DANCE') {
                    // ì¶¤ ë™ì‘ (ìœ„ì•„ë˜ + íšŒì „)
                    const danceBob = Math.sin(Date.now()*0.01) * 5;
                    ctx.translate(0, danceBob);
                    ctx.rotate(Math.sin(Date.now()*0.005) * 0.1);
                } else {
                    // ë‚˜ëŠ” ë™ì‘ (ê¸°ìš¸ê¸°)
                    ctx.rotate(this.direction * 0.5);
                }

                // ìš°ì£¼ë³µ (í°ìƒ‰ + ë‘¥ê·¼ í—¬ë©§)
                ctx.fillStyle = '#fff'; drawRoundRect(ctx, -15, -45, 30, 45, 10); // ëª¸í†µ
                // íŒ”
                if (this.state === 'DANCE') {
                    const armWag = Math.sin(Date.now()*0.02) * 10;
                    ctx.beginPath(); ctx.arc(-18, -35 + armWag, 6, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(18, -35 - armWag, 6, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.beginPath(); ctx.arc(-18, -35, 6, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(18, -35, 6, 0, Math.PI*2); ctx.fill();
                }
                // í—¬ë©§
                ctx.fillStyle = '#e0f7fa'; ctx.strokeStyle = '#fff'; ctx.lineWidth=3;
                ctx.beginPath(); ctx.arc(0, -50, 16, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                // ì–¼êµ´ (í—¬ë©§ ì•ˆ)
                ctx.fillStyle = '#fce4d4'; ctx.beginPath(); ctx.arc(0, -50, 10, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(-3,-51,1.5,0,Math.PI*2); ctx.arc(3,-51,1.5,0,Math.PI*2); ctx.fill();
                // ë‹¤ë¦¬
                ctx.fillStyle = '#fff'; ctx.fillRect(-10, 0, 8, 15); ctx.fillRect(2, 0, 8, 15);

                ctx.restore();
                return; // ìš°ì£¼ë³µ ê·¸ë¦¬ë©´ ë
            }

            // --- ê¸°ì¡´ í‰ìƒë³µ ê·¸ë¦¬ê¸° ---
            if (this.direction === -1) ctx.scale(-1, 1);
            if (this.state === 'SLEEP' || this.state === 'WRITE') { ctx.rotate(Math.PI / 2); ctx.translate(0, -15); }
            
            ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.ellipse(0, 0, 15, 5, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = this.color; drawRoundRect(ctx, -12, -40, 24, 40, 8);
            ctx.fillStyle = '#333';
            let legOffset = (this.state === 'WALK' || (this.state === 'AI_WORK' && this.timer > 490)) ? Math.sin(Date.now()*0.01)*5 : 0;
            ctx.fillRect(-8, 0, 6, 15 + legOffset); ctx.fillRect(2, 0, 6, 15 - legOffset);
            
            ctx.fillStyle = this.color; 
            if (this.state === 'READ') { ctx.beginPath(); ctx.arc(10, -25, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#fff'; ctx.fillRect(10, -35, 14, 20); ctx.fillStyle = '#3b82f6'; ctx.fillRect(10, -35, 14, 4); } 
            else if (this.state === 'PHONE') { ctx.beginPath(); ctx.arc(8, -30, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#111'; ctx.fillRect(8, -42, 10, 16); ctx.fillStyle = '#81d4fa'; ctx.fillRect(9, -41, 8, 14); } 
            else if (this.state === 'WRITE') { ctx.beginPath(); ctx.arc(12, -25, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#fff'; ctx.fillRect(12, -35, 14, 18); ctx.fillStyle = '#333'; ctx.fillRect(14, -28, 10, 2); } 
            else if (this.state === 'CLAP') { const clapY = Math.sin(Date.now()*0.02) * 5; ctx.beginPath(); ctx.arc(12, -30 + clapY, 6, 0, Math.PI*2); ctx.fill(); } 
            else if (this.state === 'PHOTO') { ctx.beginPath(); ctx.arc(10, -35, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#111'; ctx.fillRect(8, -48, 16, 12); ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(16, -42, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#eee'; ctx.fillRect(10, -50, 4, 2); } 
            else if (this.state === 'AI_WORK') { ctx.beginPath(); ctx.arc(10, -30, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#cfd8dc'; ctx.fillRect(12, -45, 2, 14); ctx.fillRect(8, -31, 16, 2); }
            else { ctx.beginPath(); ctx.arc(0, -25, 6, 0, Math.PI*2); ctx.fill(); }
            
            ctx.fillStyle = '#fce4d4'; ctx.beginPath(); ctx.arc(0, -45, 12, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#333'; const hair = this.type.hair; ctx.beginPath(); ctx.arc(0, -45, 13, Math.PI, 0); ctx.fill();
            if (hair === 'SHORT') { ctx.beginPath(); ctx.moveTo(-13, -45); ctx.lineTo(-13, -38); ctx.lineTo(-10, -45); ctx.fill(); ctx.beginPath(); ctx.moveTo(13, -45); ctx.lineTo(13, -38); ctx.lineTo(10, -45); ctx.fill(); } 
            else if (hair === 'BOB') { ctx.fillRect(-14, -45, 5, 15); ctx.fillRect(9, -45, 5, 15); } 
            else if (hair === 'MEDIUM') { ctx.fillRect(-14, -45, 6, 16); ctx.fillRect(8, -45, 6, 16); } 
            else if (hair === 'PONYTAIL') { ctx.beginPath(); ctx.arc(-12, -38, 5, 0, Math.PI*2); ctx.fill(); }
            ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(-4, -45, 1.5, 0, Math.PI*2); ctx.fill(); if (this.state === 'PHOTO') { ctx.beginPath(); ctx.moveTo(2, -45); ctx.lineTo(6, -45); ctx.stroke(); } else { ctx.beginPath(); ctx.arc(4, -45, 1.5, 0, Math.PI*2); ctx.fill(); } ctx.beginPath(); ctx.arc(0, -42, 1, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = '#333'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(-2, -39); ctx.quadraticCurveTo(0, -37, 2, -39); ctx.stroke(); 
            ctx.save(); ctx.translate(-2, -56); ctx.rotate(-0.2); ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(15,0); ctx.lineTo(8,-15); ctx.fill(); ctx.fillStyle = '#fff'; drawRoundRect(ctx, -2,0,19,5,2); ctx.beginPath(); ctx.arc(8,-15,3,0,Math.PI*2); ctx.fill(); ctx.restore();
            ctx.restore();
        }
    }

    class Animal extends Entity {
        constructor(data) {
            super(); this.type = data; this.isCat = data.id === 'CAT'; this.state = 'IDLE'; this.angryTimer = 0; 
            this.homeRoom = data.room;
            const rw = width/2; const rh = height/2;
            const rx = (this.homeRoom % 2) * rw; const ry = Math.floor(this.homeRoom / 2) * rh;
            this.x = rx + Math.random() * rw; this.y = ry + Math.random() * rh;
        }
        // [FIX] ë™ë¬¼ ëœë¤ ì´ë™ ë²”ìœ„ ì œí•œ (ìê¸° ë°©)
        setRandomTarget() {
            const rw = width/2; const rh = height/2;
            const rx = (this.homeRoom % 2) * rw; const ry = Math.floor(this.homeRoom / 2) * rh;
            this.targetX = rx + 20 + Math.random() * (rw - 40);
            this.targetY = ry + rh*0.4 + Math.random() * (rh*0.6 - 20);
        }
        returnHome() {
            this.setRandomTarget(); // ë°© ì•ˆì˜ ëœë¤ ìœ„ì¹˜
            this.state = 'FLY_HOME';
        }
        update() {
            if (isPaused) return;
            
            // [NEW] ìš°ì£¼ ëŒ„ìŠ¤
            if (isSpaceMode && this.state === 'DANCE') {
                if (spaceModeTimer <= 0) this.returnHome();
                return;
            }
            if (this.state === 'FLY_HOME') {
                this.updateMovement(5);
                return;
            }

            if (this.state === 'ANGRY') { this.angryTimer--; if (this.angryTimer <= 0) { this.state = 'IDLE'; } if (this.angryTimer > 40) this.y -= 2; else if (this.angryTimer > 20) this.y += 2; return; }
            this.timer--;
            if (this.timer <= 0) {
                const r = Math.random();
                if (this.isCat) { if (r < 0.3) { this.state = 'SIT'; this.timer = 300; } else if (r < 0.5) { this.state = 'JUMP'; this.timer = 60; } else if (r < 0.8) { this.state = 'WALK'; this.setRandomTarget(); this.timer = 300; } else { this.state = 'IDLE'; this.timer = 200; } } 
                else { if (r < 0.3) { this.state = 'RUN'; this.setRandomTarget(); this.timer = 150; } else if (r < 0.5) { this.state = 'LIE'; this.timer = 400; } else if (r < 0.8) { this.state = 'WALK'; this.setRandomTarget(); this.timer = 300; } else { this.state = 'IDLE'; this.timer = 200; } }
            }
            let speed = this.isCat ? 1 : 1.5; if (this.state === 'RUN') speed = 2.5; this.updateMovement(speed);
        }
        triggerAngry() { if (this.isCat) { this.state = 'ANGRY'; this.angryTimer = 60; } }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y); 
            
            // [NEW] ë™ë¬¼ ìš°ì£¼ë³µ
            if (this.state === 'DANCE' || this.state === 'FLY_HOME') {
                if (this.state === 'DANCE') {
                    const danceBob = Math.sin(Date.now()*0.01) * 5;
                    ctx.translate(0, danceBob);
                    ctx.rotate(Math.sin(Date.now()*0.005) * 0.1);
                } else { ctx.rotate(this.direction * 0.5); }

                // ìš°ì£¼ë³µ (ì‘ì€ ë‘¥ê·¼ í˜•íƒœ)
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, -5, 12, 0, Math.PI*2); ctx.fill();
                // í—¬ë©§
                ctx.fillStyle = '#e0f7fa'; ctx.strokeStyle = '#fff'; ctx.lineWidth=2;
                ctx.beginPath(); ctx.arc(0, -10, 14, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                // ì–¼êµ´ (í—¬ë©§ ì•ˆ)
                ctx.fillStyle = this.type.color; ctx.beginPath(); ctx.arc(0, -10, 8, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(-3,-11,1.5,0,Math.PI*2); ctx.arc(3,-11,1.5,0,Math.PI*2); ctx.fill();
                ctx.restore(); return;
            }

            if (this.direction === -1) ctx.scale(-1, 1);
            let yOffset = 0; if (this.state === 'JUMP') { yOffset = -Math.sin((60-this.timer)/60 * Math.PI) * 40; } else if (this.state === 'ANGRY') { ctx.rotate((Math.random()-0.5)*0.2); }
            let bodyBob = 0; let bodyTilt = 0; if (this.state === 'WALK' || this.state === 'RUN') { const speedFactor = this.state === 'RUN' ? 0.4 : 0.2; const walkCycle = Date.now() * speedFactor; bodyBob = Math.sin(walkCycle * 2) * 1.5; bodyTilt = Math.sin(walkCycle) * 0.05; }
            ctx.translate(0, yOffset + bodyBob); ctx.rotate(bodyTilt);
            ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.ellipse(0, 5 - yOffset - bodyBob, 12, 4, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = this.type.color;
            if (this.state === 'SIT') { ctx.beginPath(); ctx.ellipse(0, -6, 9, 11, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(0, 4, 11, 8, 0, 0, Math.PI*2); ctx.fill(); } 
            else if (this.state === 'LIE') { drawRoundRect(ctx, -14, 0, 28, 10, 5); } else if (this.state === 'ANGRY') { ctx.beginPath(); ctx.arc(0, 0, 14, Math.PI, 0); ctx.fill(); ctx.fillRect(-14, 0, 28, 8); } 
            else { if (this.type.ear === 'PUFFY') { ctx.beginPath(); ctx.arc(-6, 0, 7, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(6, 0, 7, 0, Math.PI*2); ctx.fill(); ctx.fillRect(-6, -7, 12, 14); } else { drawRoundRect(ctx, -12, -7, 24, 14, 7); if (this.type.id === 'COCKER2') { ctx.fillStyle = this.type.sub; ctx.beginPath(); ctx.arc(-4, -2, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = this.type.color; } } }
            ctx.fillStyle = this.type.color; 
            if (this.state === 'WALK' || this.state === 'RUN') { const legSpeed = this.state === 'RUN' ? 0.4 : 0.2; const l1 = Math.sin(Date.now()*legSpeed) * 6; const l2 = Math.sin(Date.now()*legSpeed + Math.PI) * 6; ctx.fillStyle = 'rgba(0,0,0,0.1)'; drawRoundRect(ctx, -10 + l2*0.8, 4, 4, 8, 2); drawRoundRect(ctx, 6 + l1*0.8, 4, 4, 8, 2); ctx.fillStyle = this.type.color; drawRoundRect(ctx, -10 + l1, 6, 4, 8, 2); drawRoundRect(ctx, 6 + l2, 6, 4, 8, 2); } 
            else if (this.state === 'SIT') { drawRoundRect(ctx, 6, 6, 4, 8, 2); } else if (this.state === 'LIE') { drawRoundRect(ctx, -14, 6, 6, 4, 2); drawRoundRect(ctx, 10, 6, 6, 4, 2); } else if (this.state === 'ANGRY') { ctx.strokeStyle = this.type.color; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(8, 0); ctx.lineTo(18, -10); ctx.stroke(); ctx.strokeStyle = 'white'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(19, -11); ctx.lineTo(23, -15); ctx.stroke(); }
            let headY = -10; if (this.state === 'SIT') headY = -18; if (this.state === 'LIE') headY = -4;
            ctx.fillStyle = this.type.color; ctx.beginPath(); ctx.arc(0, headY, 9, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = (this.type.id === 'COCKER2') ? this.type.sub : this.type.color;
            if (this.type.ear === 'POINTY') { ctx.beginPath(); ctx.moveTo(-6,headY-6); ctx.lineTo(-9,headY-12); ctx.lineTo(-3,headY-8); ctx.fill(); ctx.beginPath(); ctx.moveTo(6,headY-6); ctx.lineTo(9,headY-12); ctx.lineTo(3,headY-8); ctx.fill(); } 
            else if (this.type.ear === 'PUFFY') { ctx.beginPath(); ctx.arc(-8,headY,5,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(8,headY,5,0,Math.PI*2); ctx.fill(); } else { ctx.beginPath(); ctx.ellipse(-8, headY+2, 4, 8, 0.2, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(8, headY+2, 4, 8, -0.2, 0, Math.PI*2); ctx.fill(); }
            ctx.fillStyle = '#333'; if (this.state === 'ANGRY') { ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(-5, headY-3); ctx.lineTo(-2, headY); ctx.lineTo(-5, headY+3); ctx.stroke(); ctx.beginPath(); ctx.moveTo(5, headY-3); ctx.lineTo(2, headY); ctx.lineTo(5, headY+3); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-2, headY+4); ctx.lineTo(0, headY+2); ctx.lineTo(2, headY+4); ctx.stroke(); } else { ctx.beginPath(); ctx.arc(-3,headY-1,1.5,0,Math.PI*2); ctx.arc(3,headY-1,1.5,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(0,headY+3,1.5,1,0,0,Math.PI*2); ctx.fill(); }
            ctx.save(); ctx.translate(-3, headY-8); ctx.rotate(-0.2); ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(12,0); ctx.lineTo(6,-12); ctx.fill(); ctx.fillStyle = '#fff'; drawRoundRect(ctx, -1,0,14,4,2); ctx.beginPath(); ctx.arc(6,-12,2.5,0,Math.PI*2); ctx.fill(); ctx.restore();
            ctx.strokeStyle = this.type.color; ctx.lineWidth = 3; ctx.lineCap='round'; let tailWag = Math.sin(Date.now()*0.02)*5; if (this.state === 'ANGRY') tailWag = Math.sin(Date.now()*0.1)*10; ctx.beginPath(); ctx.moveTo(-12, 0); ctx.lineTo(-18, tailWag - 5); ctx.stroke();
            ctx.restore();
        }
    }

    function init() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
        createParticles();
        humans = []; for(let i=0; i<4; i++) humans.push(new Human(HUMAN_TYPES[i], i));
        animals = []; for(let i=0; i<4; i++) animals.push(new Animal(ANIMAL_TYPES[i]));
    }

    function createParticles() {
        particles = [];
        const tCanvas = document.createElement('canvas');
        const tCtx = tCanvas.getContext('2d');
        tCanvas.width = width; tCanvas.height = height;
        tCtx.font = '900 100px "Pretendard"';
        tCtx.fillStyle = 'white'; tCtx.textAlign = 'center';
        tCtx.textBaseline = 'middle';
        tCtx.fillText(CONFIG.text, width/2, height/2); // ì¤‘ì•™ì— ë°°ì¹˜
        try {
            const data = tCtx.getImageData(0,0,width,height).data;
            for(let y=0; y<height; y+=8) {
                for(let x=0; x<width; x+=8) {
                    if(data[(y*width+x)*4+3] > 128) particles.push(new Particle(x,y));
                }
            }
        } catch (e) { }
        for(let i=0; i<40; i++) particles.push(new Particle(Math.random()*width, Math.random()*height));
    }

    function drawScene() {
        ctx.clearRect(0, 0, width, height);
        drawRooms(ctx, width, height);
        const allEntities = [...humans, ...animals]; allEntities.sort((a,b) => a.y - b.y);
        particles.forEach(p => { p.update(); p.draw(); });
        allEntities.forEach(e => { e.update(); e.draw(); });
        hearts.forEach((h, i) => { h.update(); h.draw(); if(h.life <= 0) hearts.splice(i, 1); });
        requestAnimationFrame(drawScene);
    }

    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect(); const mx = e.clientX - rect.left; const my = e.clientY - rect.top;
        const allEntities = [...humans, ...animals];
        allEntities.forEach(ent => {
            if (ent.checkClick(mx, my)) {
                if (ent instanceof Animal && ent.isCat) { ent.triggerAngry(); } else { for(let i=0; i<3; i++) { hearts.push(new Heart(ent.x + (Math.random()-0.5)*20, ent.y - 40)); } }
            }
        });
    });

    window.addEventListener('resize', () => { setTimeout(() => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; init(); }, 200); });

    window.togglePause = () => { isPaused = !isPaused; document.getElementById('btn-pause').innerText = isPaused ? 'â–¶' : 'â¸'; };
    window.resetSimulation = init;
    
    window.closeModal = () => { document.getElementById('my-msg-modal').style.display='none'; document.getElementById('modal-overlay').style.display='none'; };

    const sendBtn = document.getElementById('send-btn');
    const msgInput = document.getElementById('msg-input');
    const senderSelect = document.getElementById('sender-select');
    const receiverSelect = document.getElementById('receiver-select');

    sendBtn.addEventListener('click', async () => {
        const sender = senderSelect.value; const receiver = receiverSelect.value; const rawText = msgInput.value.trim();
        if(!rawText) return alert('ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        let finalMessage = rawText; if (sender !== 'ìµëª…') { finalMessage = `[${sender}] ${rawText}`; }
        const orgBtn = sendBtn.innerText; sendBtn.innerText = 'ğŸš€'; sendBtn.disabled = true;
        try {
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'}, body: JSON.stringify({ name: receiver, text: finalMessage }) });
            alert('ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ! ğŸ“¨'); msgInput.value = '';
        } catch(e) { alert('ì „ì†¡ ì‹¤íŒ¨ ã… ã… '); } finally { sendBtn.innerText = orgBtn; sendBtn.disabled = false; }
    });

    window.openMyMsgModal = () => {
        document.getElementById('modal-overlay').style.display='block'; document.getElementById('my-msg-modal').style.display='flex';
        document.getElementById('my-name-auth').value = '';
    };

    window.checkMyMessages = async () => {
        const name = document.getElementById('my-name-auth').value.trim();
        if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        const con = document.getElementById('msg-list-container');
        con.innerHTML = '<div class="spinner"></div><div style="text-align:center; color:#64748b;">ìš°ì£¼ì—ì„œ í¸ì§€ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL + '?t=' + Date.now()); const data = await res.json();
            const myMsgs = data.filter(r => r[1] === name || r[1] === 'ALL').reverse();
            con.innerHTML = '';
            if(myMsgs.length === 0) { con.innerHTML = `<div style="text-align:center; margin-top:100px; color:#94a3b8;">ë„ì°©í•œ í¸ì§€ê°€ ì—†ì–´ìš” ğŸ˜¢<br>ì¹œêµ¬ë“¤ì—ê²Œ ë¨¼ì € ë³´ë‚´ë³´ì„¸ìš”!</div>`; return; }
            myMsgs.forEach(m => {
                const date = new Date(m[0]); const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
                const receiverName = m[1] === 'ALL' ? 'ğŸ“¢ ëª¨ë‘ì—ê²Œ' : `To. ${m[1]}`; const content = m[2];
                const d = document.createElement('div'); d.className = 'post-it-card'; d.style.padding='15px'; d.style.marginBottom='10px'; d.style.borderRadius = '12px'; d.style.border = '1px solid #f1f5f9';
                if (m[1] === 'ALL') d.style.background = '#e0f2fe';
                d.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; border-bottom:1px dashed rgba(0,0,0,0.1); padding-bottom:5px;"><span style="font-weight:bold; color:#475569; font-size:0.9rem;">${receiverName}</span><span style="font-size:0.75rem; color:#94a3b8;">${dateStr}</span></div><div style="font-size:1rem; color:#334155; line-height:1.5; word-break:break-all;">${content}</div>`;
                con.appendChild(d);
            });
        } catch(e) { con.innerHTML = '<div style="text-align:center; margin-top:50px; color:#ef4444;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>'; }
    };
</script>
</body>
</html>
